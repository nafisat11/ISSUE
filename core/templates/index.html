{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %} 

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<style>
/*    div#container {
      top:50%;
      left:50%;
      transform: translate(-50%,-50%);
      position:absolute;
    }

    svg {
      cursor:pointer;
    }

    rect.checked {
      fill:#48EA8B;
    }

    div.parent {
        width: 100%;
        /*height: 300px;*/
        /*background-color: #C0C0C0;
        position: relative;
    }

    div.panzoom {
        width: 400px;
        height: 300px;
        position: relative;
        /*display: grid;
    }

    div.grid, img {
        width: 100%;
        height: 100%;
        /*grid-area: 1 / 1;
        position: absolute;
    }

    div.grid {
        z-index: 1;
        top: 37.25%; 
        left: 27.5%;
    }

    div.buttons {
      display: flex;
      justify-content: center;
    }
*/
    .wrapper {
        position: relative;
        width: 700px;
        height: 550px;
    }
    .wrapper canvas {
        position: absolute;
        top: 0;
        left: 0;
    }

</style>
{% endblock stylesheets %}

{% block content %}
    <!-- [ Main Content ] start -->
    <div class="pcoded-main-container">
        <div class="pcoded-content">
            <!-- [ breadcrumb ] start -->
            <!-- <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <div class="page-header-title">
                                <h5 class="m-b-10">Dashboard Analytics</h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html"><i class="feather icon-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="#!">Dashboard Analytics</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div> -->
            <!-- [ breadcrumb ] end -->
            <!-- [ Main Content ] start -->
            <div class="row">
                <!-- seat-selection start -->
                <div class="col-lg-5">
                    <div class="card">                        
                        <div class="card-header">
                            <h5>Seat Selection</h5>
                            <div class="card-header-right">
                                <div id='visibility_toggle_button'>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 92.604 92.604" height="40" width="40" id='radio-btn'>
                                        <g transform="translate(0 -204.396)">
                                            <rect id='visibility_toggle_button_container' ry="15.875" y="234.823" x="12.662" height="31.75" width="67.28" fill="#ff4651" paint-order="markers fill stroke"/>
                                            <ellipse id='visibility_toggle_button_disk' rx="9.028" ry="9.028" cy="250.865" cx="28.911" fill="none" stroke="#fff" stroke-width="5.5" stroke-linecap="round" stroke-linejoin="round" paint-order="markers fill stroke"/>
                                        </g>
                                    </svg>
                                </div>
                            </div>
                            <!-- <div class="card-header-right">
                                <div class="btn-group card-option">
                                    <button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="feather icon-more-horizontal"></i>
                                    </button>
                                    <ul class="list-unstyled card-option dropdown-menu dropdown-menu-right">
                                        <li class="dropdown-item full-card"><a href="#!"><span><i class="feather icon-maximize"></i> maximize</span><span style="display:none"><i class="feather icon-minimize"></i> Restore</span></a></li>
                                        <li class="dropdown-item minimize-card"><a href="#!"><span><i class="feather icon-minus"></i> collapse</span><span style="display:none"><i class="feather icon-plus"></i> expand</span></a></li>
                                        <li class="dropdown-item reload-card"><a href="#!"><i class="feather icon-refresh-cw"></i> reload</a></li>
                                        <li class="dropdown-item close-card"><a href="#!"><i class="feather icon-trash"></i> remove</a></li>
                                    </ul>
                                </div>
                            </div> -->
                        </div>
                            <img class="card-img-top" src="/static/assets/images/room_maps/ENC_170.PNG" width="700" height="550">
                                <div class="card-body">
                                    <div class="row justify-content-center card-option">
                                        <button type="button" class="btn btn-icon btn-outline-primary border-0 reload-card" id='reset_button'>
                                            <i class="feather icon-refresh-ccw"></i></a>
                                        </button>
                                        <button type="button" class="btn  btn-icon btn-outline-secondary border-0">
                                            <i class="feather icon-grid"></i>
                                        </button>
                                        <button type="button" class="btn  btn-icon btn-outline-success border-0">
                                            <i class="feather icon-square"></i>
                                        </button>
                                        <button type="button" class="btn  btn-icon btn-outline-danger border-0">
                                            <i class="feather icon-hash"></i>
                                        </button>
                                        <button type="button" id="SubmitSelection" class="btn btn-success" onclick="generateHeatmap()">Generate</button>
                                    </div>
                                    <br>
                                    <h5 class="text-black">Max Occupancy<span class="float-right maxOccup"></span></h5>
                                    <h5 class="text-black">Max Pandemic Occupancy<span class="float-right maxPanOccup"></span>
                                </div>
                        <!-- seat-selection end -->
                        <!-- infection-parameter start -->
                        <div class="dropdown-divider"></div>
                        <div class="card-header">
                            <h5>Infection Parameters</h5>      
                        </div>
                        <div class="card-body">
                            <div class="form-group row">
                                <div class="col-sm-5">Personal Protective Equipment</div>
                                <div class="col-sm-7">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="gridCheck1">
                                        <label class="form-check-label" for="gridCheck1">Mask</label>
                                    </div>
                                </div>
                                <div class="col-md-4">Duration (hours)</div>
                                    
                            </div>
                            <div class="d-flex justify-content-left my-4">
                                <form class="range-field w-25">
                                    <input id="duration-slider" class="border-0" type="range" min="0" max="10" />
                                </form>
                                <span class="font-weight-bold indigo-text ml-6 mt-1 valueSpan"></span>
                            </div>
                            <!-- <div class="parent" id="seat_selector_container">
                                <div class="panzoom" id="panzoom_container">
                                    <div class="grid" id="grid"></div>
                                    <img src="/static/assets/images/room_maps/ENC_170.PNG">
                                </div>
                            </div> -->
                            
                        </div>
                        <!-- infection-parameter end -->
                    </div>
                </div>
                <!-- seat-selection end -->
                <!-- heat-map start -->
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header"><h5>Heat Map</h5></div>
                        <div class="card-body">
                            <div class="parent" id="heatmap_container">
                                <div id="probabilitiesSelect"></div>
                                <div class="wrapper">
                                    <div><canvas id="backgroundCanvas" width="700" height="550"></canvas></div>
                                    <div><canvas id="heatmapCanvas" width="700" height="550" style="opacity:0.5"></canvas></div>
                                </div>
                            </div> 
                        </div>
                    </div>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="card">
                        <div class="card-header"><h5>Temporal Graph 1</h5></div>
                        <div class="card-body d-flex flex-column">
                            <div id="temporal1"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- [ Main Content ] end -->
        </div>
    </div>
    <!-- [ Main Content ] end -->

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

    <!-- Apex Chart -->
    <script src="/static/assets/js/pages/chart-apex.js"></script>
    <script src="/static/assets/js/plugins/apexcharts.min.js"></script>
    <!-- custom-chart js -->
    <script src="/static/assets/js/pages/dashboard-main.js"></script>
    <script>
        $(document).ready(function() {
            const $valueSpan = $('.valueSpan');
            const $value = $('#duration-slider');
            $valueSpan.html($value.val());
            $value.on('input change', () => {

                $valueSpan.html($value.val());
            });
        });
    </script>
    <!-- seat-selection js-->
    <script src="https://d3js.org/d3.v5.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.panzoom/4.0.0/panzoom.min.js"></script>
    <script src="./static/assets/js/simpleheat.js"></script>
    <script>

    // Temporal Graph
    // Fake Attack Rate Data:
    var temporalData = [10, 28, 35, 41, 51, 62, 69, 91, 100];

    // Chart customization
    var options = {
          series: [{
            name: "Attack Rate",
            data: temporalData
        }],
          chart: {
          height: 350,
          type: 'line',
          zoom: {
            type: 'x',
            enabled: true,
            autoScaleYaxis: true
          },
          toolbar: {
            autoSelected: 'zoom'
          }
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          curve: 'smooth'
        },
        title: {
          text: 'Attack Rate as a Function of Time',
          align: 'left'
        },
        xaxis: {
          categories: ['0', '1', '2', '3', '4', '5', '6', '7', '8'],
          title: {
              text: "Time (hrs)"
          }
        },
        yaxis: {
            title: {
                text: "Attack Rate (%)"
            }
        },
        tooltip: {
            enabled: true,
            enabledOnSeries: undefined,
            shared: true,
            followCursor: false,
            intersect: false,
            inverseOrder: false,
            custom: undefined,
            fillSeriesColor: false,
            theme: false,
            style: {
                fontSize: '12px',
                fontFamily: undefined
            },
            onDatasetHover: {
                highlightDataSeries: false,
            },
            x: {
                show: true,
                format: 'dd MMM',
                formatter: undefined,
            },
            y: {
                formatter: undefined,
                title: {
                    formatter: (seriesName) => seriesName,
                },
            },
            z: {
                formatter: undefined,
                title: 'Size: '
            },
            marker: {
                show: true,
            },
            fixed: {
                enabled: false,
                position: 'topRight',
                offsetX: 0,
                offsetY: 0,
            },
        }
    };

    var chart = new ApexCharts(document.querySelector("#temporal1"), options);
    chart.render();

    //Heatmap
    //Heatmap Data
    //Get request to the database
    $(document).ready(function() {
        var $probabilitiesvar = $("#probabilitiesSelect");
        $probabilitiesvar.change(function() {
            data = {'user_id': "1", 'room_id': "1"};
            $.ajax({
                type: "GET",
                url: '/get_probabilities/',
                data: data,
                success: function(result) {

                },
            });
        });
    });

    //Update Background Image
    function setBackground(buildingName, roomName){
        roomName = roomName;
        imageLocation = "/static/assets/images/room_maps/";
        fileType = ".PNG"

        //RegExp for getting the building name initials
        var buildingInitials = buildingName.match(/\b\w/g) || [];
        buildingInitials = ((buildingInitials.shift() || '') + (buildingInitials.pop() || '')).toUpperCase();
        
        //Updating background with "new" room map
        var c = document.getElementById("backgroundCanvas");
        var ctx = c.getContext("2d");
        var background = new Image();
        background.onload = function(){
                  ctx.drawImage(background, 0, 0, 700, 550);
        };
        background.src = imageLocation.concat(buildingInitials, "_", roomName, fileType);
    }

    //Heatmap Background Image
    var canvas = document.getElementById("backgroundCanvas");
    var ctx = canvas.getContext("2d");
    var background = new Image();
    background.src = "/static/assets/images/room_maps/Room_Select.PNG";
    
    // Make sure the image is loaded first otherwise nothing will draw.
    background.onload = function(){
        ctx.drawImage(background, 0, 0, 700, 550);
    }

    function generateHeatmap(){
        //Heatmap Data
        //Get request to the database
        // $(document).ready(function() {
        //     var $probabilitiesvar = $("#probabilitiesSelect");
        //     $probabilitiesvar.change(function() {
        //         data = {'user_id': userId, 'room_id': roomName};
        //         $.ajax({
        //             type: "GET",
        //             url: '/get_probabilities/',
        //             data: data,
        //             success: function(result) {
        //                 sampleData = result;
        //             },
        //         });
        //     });
        // });

        //Fake Probabilities data
        var heatmapData = [];
        for (var i = 0; i < 550; i++){
            var temp = [];
            for (var j = 0; j < 700; j++){
                temp.push(Math.floor(Math.random() * 101));
            }
            heatmapData.push(temp);
        }

        // Heatmap figure
        sampleData = [];
        for (var i = 0; i < 700; i+=20){
            for (var j = 0; j < 550; j+=20){
                temp = [i, j, heatmapData[j][i]];
                sampleData.push(temp);
            }
        }
        function get(id) {
            return document.getElementById(id);
        }

        var heat = simpleheat('heatmapCanvas').data(sampleData).max(100),
            frame;

        function draw() {
            heat.draw();
            frame = null;
        }
        draw();
    }

    </script>

{% endblock javascripts %}
